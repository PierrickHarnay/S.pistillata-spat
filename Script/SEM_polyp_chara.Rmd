---
title: "SEM_polyp_chara"
output: html_document
---

Load all th packages needs for the code
```{r}
## load libraries
library(ggplot2)
library(readr)
library(dplyr)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(lubridate)
library(cowplot)
library(ggthemes)
library(patchwork)
library(multcomp)
library(multcompView)
```

```{r}
#loading data
sem <- read_csv("Data/Mineral/SEM_polyp_diameters.csv")

```
```{r}
#cleaning data and prepare the data for the first analysis 
#removing the Na presented in the dataset

sem_clean_data <- sem[rowSums(is.na(sem)) != ncol(sem), ]

```

```{r}
############## SECTION WITH THE MEAN DATA AND NOT ALL POINTS ###########################
#created average for Primary secondary tertiary septa, corallite diameters, columella etc 
# Load your data
SEM_data <- read.csv("Data/Mineral/SEM_polyp_diameters.csv", stringsAsFactors = FALSE)

# Clean column names (remove spaces and make consistent)
names(SEM_data) <- trimws(names(SEM_data))

names(SEM_data)

# Calculate averages for Primary_septa grouped by its label column
avg_primary <- aggregate(SEM_data$Primary_septa,
                         by = list(SEM_data$Primary_septa_number),
                         FUN = mean, na.rm = TRUE)

# Rename columns for clarity
colnames(avg_primary) <- c("Primary_septa_number", "Mean_Primary_septa")

write.csv(avg_primary, "Output/Average_Primary_Septa.csv", row.names = FALSE)
#doing the same process for the others parameter wanted to have result of 
avg_secondary <- aggregate(SEM_data$Secondary_septa,
                         by = list(SEM_data$Secondary_septa_number),
                         FUN = mean, na.rm = TRUE)

colnames(avg_secondary) <- c("Secondary_septa_number", "Mean_Secondary_septa")
write.csv(avg_secondary, "Output/Average_Secondary_Septa.csv", row.names = FALSE)


avg_tertiary <- aggregate(SEM_data$Tertiary_septa,
                         by = list(SEM_data$Tertiary_septa_number),
                         FUN = mean, na.rm = TRUE)

colnames(avg_tertiary) <- c("Tertiary_septa_number", "Mean_Tertiary_septa")
write.csv(avg_tertiary, "Output/Average_Tertiary_Septa.csv", row.names = FALSE)


avg_corallite <- aggregate(SEM_data$Corallite_Diameter,
                         by = list(SEM_data$Polyp_number),
                         FUN = mean, na.rm = TRUE)

colnames(avg_corallite) <- c("Corallite_number", "Mean_Corallite")
write.csv(avg_corallite, "Output/Average_Corallite.csv", row.names = FALSE)


avg_columella <- aggregate(SEM_data$Columella,
                         by = list(SEM_data$Polyp_number),
                         FUN = mean, na.rm = TRUE)

colnames(avg_columella) <- c("Columella_number", "Mean_Columella")
write.csv(avg_columella, "Output/Average_Columella.csv", row.names = FALSE)

#merging all the tables in one dataset 
# --- Standardize the grouping column name so all can merge ---
names(avg_primary)[1]   <- "Polyp_ID"
names(avg_secondary)[1] <- "Polyp_ID"
names(avg_tertiary)[1]  <- "Polyp_ID"
names(avg_corallite)[1] <- "Polyp_ID"
names(avg_columella)[1] <- "Polyp_ID"

# --- Merge all average tables into one dataset ---
merged_SEM <- Reduce(function(x, y) merge(x, y, by = "Polyp_ID", all = TRUE),
                     list(avg_primary, avg_secondary, avg_tertiary, avg_corallite, avg_columella))

write.csv(merged_SEM, "Output/merged_SEM_data.csv", row.names = FALSE)


```

```{r}
############## SECTION WITH THE MEAN DATA AND NOT ALL POINTS ###########################
#plot the result 
#loading data from the file merged_SEM_data
merged_SEM_data <- read.csv("Output/merged_SEM_data.csv", stringsAsFactors = FALSE)

#created the file where we extract the number of polyp via the name of 'Polyp_ID' 
merged_SEM_data_polyp <- read.csv("Output/merged_SEM_data.csv")

# Extract the number after 'polyp' and before the next underscore
merged_SEM_data_polyp <- merged_SEM_data_polyp %>%
 mutate(Polyp_Number = as.numeric(str_extract(Polyp_ID, "(?<=polyp)\\d+")))

#ploting the coralite diameters with boxplot. AVERAGE of all of them with only few points 
merged_SEM_data_polyp$Polyp_Number <- as.numeric(as.character(merged_SEM_data_polyp$Polyp_Number))

head(merged_SEM_data_polyp)
colnames(merged_SEM_data_polyp)

#creation of a file with only the 9 first raw of the dataset with the Corallite and Columella diameters
# Keep only the first 9 rows
Corallite_columella_merge <- merged_SEM_data_polyp[1:9, ]

# Save to a new CSV file
write.csv(Corallite_columella_merge, "Corallite_columella_merge.csv", row.names = FALSE)

#remove column Polyp_number to the dataset
Corallite_columella_merge <- Corallite_columella_merge[ , !(names(Corallite_columella_merge) %in% "Polyp_Number")]

#rename the column Polyp_ID to Polyp_Number 
Corallite_columella_merge <- Corallite_columella_merge %>%
  rename(
    Polyp_Number = Polyp_ID
  )

####starting to plot the data 
#PRIMARY
avg_primary <- ggplot(merged_SEM_data_polyp, aes(x = factor(Polyp_Number), y = Mean_Primary_septa))+
  geom_boxplot(outlier.shape = NA, fill = "darkslategray3", width = 0.5, alpha = 0.5) +  
  geom_jitter(width = 0.5, color = "black", size = 1, alpha = 0.5) + 
  labs(x = "Polyp number", y = "Mean primary septa width (µm)") +
  theme_minimal()

ggsave("Output/avg_primary.png", plot = avg_primary, width = 10, height = 5, dpi = 400)

#SECONDARY
avg_secondary <- ggplot(merged_SEM_data_polyp, aes(x = factor(Polyp_Number), y = Mean_Secondary_septa)) + geom_boxplot(outlier.shape = NA, fill = "darkslategray3", width = 0.5, alpha = 0.5) +  
  geom_jitter(width = 0.2, color = "black", size = 1, alpha = 0.5)+ 
  labs(x = "Polyp number", y = "Mean secondary septa width (µm)") +
  theme_minimal()

ggsave("Output/avg_secondary.png", plot = avg_secondary, width = 10, height = 5, dpi = 400)

#filter the dataset and keep only the 2 groups where we have data points 
filtered_data <- merged_SEM_data_polyp %>% 
  filter(Polyp_Number %in% c(3, 5))

avg_tertiary <- ggplot(merged_SEM_data_polyp, aes(x = factor(Polyp_Number), y = Mean_Tertiary_septa)) +
  geom_boxplot(outlier.shape = NA, fill = "darkslategray3", width = 0.5, alpha = 0.5) +  
  geom_jitter(width = 0.2, color = "black", size = 1, alpha = 0.5) +  
  labs(x = "Polyp number", y = "Mean tertiary septa width (µm)") +
  theme_minimal()

ggsave("Output/avg_tertiary.png", plot = avg_tertiary, width = 10, height = 5, dpi = 400)

avg_columella <- ggplot(Corallite_columella_merge, aes(x = factor(Polyp_Number), y = Mean_Columella)) +
  geom_jitter(width = 0.2, color = "black", size = 1, alpha = 0.5) +  
  labs(x = "Polyp number", y = "Mean columella diameter (µm)") +
  theme_minimal()

ggsave("Output/avg_columella.png", plot = avg_columella, width = 10, height = 5, dpi = 400)


avg_corallite <- ggplot(Corallite_columella_merge, aes(x = factor(Polyp_Number), y = Mean_Corallite)) +
  geom_jitter(width = 0.2, color = "black", size = 1, alpha = 0.5) +
  labs(
    x = "Polyp number", y = "Mean corallite diameter (µm)") +
  theme_minimal()

ggsave("Output/avg_corallite.png", plot = avg_corallite, width = 10, height = 5, dpi = 400)

#Merging all the graph all together 
avg1 <- avg_corallite + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 

avg2 <- avg_primary + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 

avg3 <- avg_secondary + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 
avg4 <- avg_tertiary + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 

avg5 <- avg_columella + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 

# Combine plots
avg_combined_plot <- (avg1 | avg2) / (avg3 | avg4) / (avg5)+
  plot_annotation(tag_levels = 'A')

# Save to file
ggsave("Output/avg_combined_plot.pdf", avg_combined_plot, width = 12, height = 10)

``` 
```{r}
############## SECTION WITH THE MEAN DATA AND NOT ALL POINTS ###########################
#let take a look to the assemtpion of the data 
#create separe file for each variable in the dataset

#CORALLITE
Corallite <- merged_SEM_data_polyp[, c("Polyp_Number", "Mean_Corallite")]
Corallite_without_Na <- na.omit(Corallite)

#removing outlier 
Corallite_outlier <- Corallite_without_Na %>%
  filter(
    Mean_Corallite >= quantile(Mean_Corallite, 0.25) - 1.5 * IQR(Mean_Corallite),
    Mean_Corallite <= quantile(Mean_Corallite, 0.75) + 1.5 * IQR(Mean_Corallite)
  )

# Before removing outliers
ggplot(Corallite_without_Na, aes(x = factor(Polyp_Number), y = Mean_Corallite)) +
  geom_boxplot() +
  ggtitle("Before removing outliers")

# After removing outliers
ggplot(Corallite_outlier, aes(x = factor(Polyp_Number), y = Mean_Corallite)) +
  geom_boxplot() +
  ggtitle("After removing outliers")

#PRIMARY SEPTA
Psepta <- merged_SEM_data_polyp[, c("Polyp_number", "Mean_Primary_septa")]
Psepta_without_Na <- na.omit(Psepta)

#removing outlier 
Psepta_outlier <- Psepta_without_Na %>%
  filter(
    Mean_Primary_septa >= quantile(Mean_Primary_septa, 0.25) - 1.5 * IQR(Mean_Primary_septa),
    Mean_Primary_septa <= quantile(Mean_Primary_septa, 0.75) + 1.5 * IQR(Mean_Primary_septa)
  )

# Before removing outliers
ggplot(Psepta_without_Na, aes(x = factor(Polyp_Number), y = Mean_Primary_septa)) +
  geom_boxplot() +
  ggtitle("Before removing outliers")

# After removing outliers
ggplot(Psepta_outlier, aes(x = factor(Polyp_Number), y = Mean_Primary_septa)) +
  geom_boxplot() +
  ggtitle("After removing outliers")

#SECONDARY SEPTA
Ssepta <- merged_SEM_data_polyp[, c("Polyp_number", "Mean_Secondary_septa")]
Ssepta_without_Na <- na.omit(Ssepta)

#removing outlier 
Ssepta_outlier <- Ssepta_without_Na %>%
  filter(
    Mean_Secondary_septa >= quantile(Mean_Secondary_septa, 0.25) - 1.5 * IQR(Mean_Secondary_septa),
    Mean_Secondary_septa <= quantile(Mean_Secondary_septa, 0.75) + 1.5 * IQR(Mean_Secondary_septa)
  )

# Before removing outliers
ggplot(Ssepta_without_Na, aes(x = factor(Polyp_Number), y = Mean_Secondary_septa)) +
  geom_boxplot() +
  ggtitle("Before removing outliers")

# After removing outliers
ggplot(Ssepta_outlier, aes(x = factor(Polyp_Number), y = Mean_Secondary_septa)) +
  geom_boxplot() +
  ggtitle("After removing outliers")

#TERTIARY SEPTA
Tsepta <- merged_SEM_data_polyp[, c("Polyp_number", "Mean_Tertiary_septa")]
Tsepta_without_Na <- na.omit(Tsepta)

#removing outlier 
Tsepta_outlier <- Tsepta_without_Na %>%
  filter(
    Mean_Tertiary_septa >= quantile(Mean_Tertiary_septa, 0.25) - 1.5 * IQR(Mean_Tertiary_septa),
    Mean_Tertiary_septa <= quantile(Mean_Tertiary_septa, 0.75) + 1.5 * IQR(Mean_Tertiary_septa)
  )

# Before removing outliers
ggplot(Tsepta_without_Na, aes(x = factor(Polyp_Number), y = Mean_Tertiary_septa)) +
  geom_boxplot() +
  ggtitle("Before removing outliers")

# After removing outliers
ggplot(Tsepta_outlier, aes(x = factor(Polyp_Number), y = Mean_Tertiary_septa)) +
  geom_boxplot() +
  ggtitle("After removing outliers")

#COLUMELLA SEPTA
Columella <- merged_SEM_data_polyp[, c("Polyp_number", "Mean_Columella")]
Columella_without_Na <- na.omit(Columella)

#removing outlier 
Columella_outlier <- Columella_without_Na %>%
  filter(
    Mean_Columella >= quantile(Mean_Columella, 0.25) - 1.5 * IQR(Mean_Columella),
    Mean_Columella <= quantile(Mean_Columella, 0.75) + 1.5 * IQR(Mean_Columella)
  )

# Before removing outliers
ggplot(Columella_without_Na, aes(x = factor(Polyp_Number), y = Mean_Columella)) +
  geom_boxplot() +
  ggtitle("Before removing outliers")

# After removing outliers
ggplot(Columella_outlier, aes(x = factor(Polyp_Number), y = Mean_Columella)) +
  geom_boxplot() +
  ggtitle("After removing outliers")

```
```{r}
############## SECTION WITH THE MEAN DATA AND NOT ALL POINTS ###########################
#vizualisation of the data via graph
#CORALLITE
hist(Corallite_outlier$Mean_Corallite,
     main = "Histogram of the mean of corallite Diameter",
     xlab = "Mean corallite",
     breaks = 15)

#PRIMARY SEPTA
hist(Psepta_outlier$Mean_Primary_septa,
     main = "Histogram of the mean of primary septa",
     xlab = "Mean of primary septa",
     breaks = 15)

#Secondary SEPTA
hist(Ssepta_outlier$Mean_Secondary_septa,
     main = "Histogram of Secondary septa",
     xlab = "Mean of secondary septa",
     breaks = 15)

#tertiary septa
hist(Tsepta_outlier$Mean_Tertiary_septa,
     main = "Histogram of Tertiary septa",
     xlab = "Mean of tertiary septa",
     breaks = 15)

#COLUMELLA 
hist(Columella_outlier$Mean_Columella,
     main = "Histogram of the mean of Columella",
     xlab = "Mean ofcolumella",
     breaks = 15)

#Q-Q plot 
#CORALLITE
qqnorm(Corallite_outlier$Mean_Corallite)
qqline(Corallite_outlier$Mean_Corallite, col = "red")

#Primary septa
qqnorm(Psepta_outlier$Mean_Primary_septa)
qqline(Psepta_outlier$Mean_Primary_septa, col = "red")

#secondary septa 
qqnorm(Ssepta_outlier$Mean_Secondary_septa)
qqline(Ssepta_outlier$Mean_Secondary_septa, col = "red")

#Tertiary septa 
qqnorm(Tsepta_outlier$Mean_Tertiary_septa)
qqline(Tsepta_outlier$Mean_Tertiary_septa, col = "red")

#Tertiary septa 
qqnorm(Columella_outlier$Mean_Columella)
qqline(Columella_outlier$Mean_Columella, col = "red")

#statistic part
#normality on coralitte diameter µm 
shapiro.test(residuals(aov(Mean_Corallite ~ Polyp_number, data = Corallite_outlier)))
#normality validated
#normality on primary septa witdh µm
shapiro.test(residuals(aov(Mean_Primary_septa ~ Polyp_number, data = Psepta_outlier)))
#normality validated
#normality on secondary septa witdh µm
shapiro.test(residuals(aov(Mean_Secondary_septa ~ Polyp_number, data = Ssepta_outlier)))
#normality validated
#normality on tertiary septa witdh µm
shapiro.test(residuals(aov(Mean_Tertiary_septa ~ Polyp_number, data = Tsepta_outlier)))
#do not follow the normality need to used a Kruskal-Wallis test 
#normality on columella witdh µm
shapiro.test(residuals(aov(Mean_Columella ~ Polyp_number, data = Columella_outlier)))
#normality validated

#ANOVA test
#CORALLITE ################## We can't compare because only one point per dataset of polyp number #######
anova_result_coralitte <- aov(Mean_Corallite ~ factor(Polyp_number), data = Corallite_outlier)
summary(anova_result_coralitte)
#Post-Hoc comparaison 
tukey_result_coralitte <- TukeyHSD(anova_result_coralitte)
tukey_result_coralitte

##################

#PRIMARY septa
anova_result_primary <- aov(Mean_Primary_septa ~ factor(Polyp_number), data = Psepta_outlier)
summary(anova_result_primary)
#Post-Hoc comparaison 
tukey_result_primary <- TukeyHSD(anova_result_primary)
tukey_result_primary

anova_result_primary <- aov(Mean_Primary_septa ~ factor(Polyp_number), data = Psepta_outlier)
summary(anova_result_primary)
#resume of the anova
#p-value: 0.00223 

TukeyHSD(anova_result_primary)
#resume of significant values 
#3-1   45.30700  16.456371 74.15762898 0.0002840
#8-1   30.24656   1.395931 59.09718898 0.0339409

##################

#Secondary septa
anova_result_secondary <- aov(Mean_Secondary_septa ~ factor(Polyp_number), data = Ssepta_outlier)
summary(anova_result_secondary)
#Post-Hoc comparaison 
tukey_result_secondary <- TukeyHSD(anova_result_secondary)
tukey_result_secondary

anova_result_secondary <- aov(Mean_Secondary_septa ~ factor(Polyp_number), data = Ssepta_outlier)
summary(anova_result_secondary)
#resume of the anova
#p-value: 0.00399 

TukeyHSD(anova_result_secondary)
#resume of significant values 
# diff        lwr        upr     p adj
#3-1   20.8596800   6.450904 35.2684559 0.0010216
#5-3  -15.1949200 -29.603696 -0.7861441 0.0324880
#6-3  -15.0961200 -29.504896 -0.6873441 0.0343286

##################

#Tertiary septa
anova_result_tertiary <- aov(Mean_Tertiary_septa ~ factor(Polyp_number), data = Tsepta_outlier)
summary(anova_result_tertiary)
#Post-Hoc comparaison 
tukey_result_tertiary <- TukeyHSD(anova_result_tertiary)
tukey_result_tertiary

anova_result_tertiary <- aov(Mean_Tertiary_septa ~ factor(Polyp_number), data = Tsepta_outlier)
summary(anova_result_tertiary)
#resume of the anova
#p-value:0.147   

TukeyHSD(anova_result_tertiary)
#resume of significant values 
# diff        lwr        upr     p adj
#5-3 6.250317 -3.42938 15.93001 0.1474699

################## We can't compare because only one point per dataset of polyp number #######
#Columella 
anova_result_columella <- aov(Mean_Columella ~ factor(Polyp_number), data = Columella_outlier)
summary(anova_result_columella)
#Post-Hoc comparaison 
tukey_result_columella <- TukeyHSD(anova_result_columella)
tukey_result_columella


```



























```{r}
#Define for each number of polyp spat a color different 
#polyp_colors <- c(
#  "1" = "red",
#  "2" = "blue",
#  "3" = "green",
#  "4" = "purple",
#  "5" = "orange",
#  "6" = "gray",
#  "7" = "black",
#  "8" = "yellow",
#  "9" ="pink",
#  "10" = "darkblue"
#  )

#ploting the coralite diameters with boxplot and point repartition 
coralite_diameters <- ggplot(sem_clean_data, aes(x = factor(Polyp_number),
                  y = Corallite_Diameter,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Corallite diameter (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 25)+
  theme( axis.title.x = element_text(size = 12),     # X-axis title
    axis.title.y = element_text(size = 12),     # Y-axis title
    axis.text.x  = element_text(size = 12),     # X-axis tick labels
    axis.text.y  = element_text(size = 12),     # Y-axis tick labels
    legend.title = element_text(size = 12),     # Legend titles
    legend.text  = element_text(size = 12)      # Legend labels
    )

ggsave("Output/coralite_diameters.png", plot = coralite_diameters, width = 10, height = 5, dpi = 500)

#plotting the data with the same concept to vizualize the point distribution of the corallite diameters in µm but via violont plot 
#ggplot(sem_clean_data, aes(x = factor(Polyp_number),
 #                 y = Corallite_Diameter,
  #              fill = factor(Polyp_number),
   #               color = factor(Polyp_number))) +
  #geom_violin(outlier.shape = NA, alpha = 0.5) +
  #geom_jitter(width = 0.2, size = 2, alpha = 0.8) +
  #scale_fill_tableau(palette = "Jewel Bright") +
  #scale_color_tableau(palette = "Jewel Bright") +
  #labs(x = "Number of polyps per spat",
  #     y = "Corallite diameter (µm)",
  #     fill = "Polyp Number",
  #     color = "Polyp Number") +
  #theme_minimal(base_size = 14)


#ploting the primary septa with boxplot and point repartition 
primary_septa <- ggplot(sem_clean_data, aes(x = factor(Polyp_number),
                  y = Primary_septa,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Primary septa width (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 14)+ 
   theme( axis.title.x = element_text(size = 12),     # X-axis title
    axis.title.y = element_text(size = 12),     # Y-axis title
    axis.text.x  = element_text(size = 12),     # X-axis tick labels
    axis.text.y  = element_text(size = 12),     # Y-axis tick labels
    legend.title = element_text(size = 12),     # Legend titles
    legend.text  = element_text(size = 12)      # Legend labels
    )

ggsave("Output/primary_septa.png", plot = primary_septa, width = 10, height = 5, dpi = 500)

#ploting the secondary septa with boxplot and point repartition 
secondary_septa <- ggplot(sem_clean_data, aes(x = factor(Polyp_number),
                  y = Secondary_septa,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Secondary septa width (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 14)+ 
   theme( axis.title.x = element_text(size = 12),     # X-axis title
    axis.title.y = element_text(size = 12),     # Y-axis title
    axis.text.x  = element_text(size = 12),     # X-axis tick labels
    axis.text.y  = element_text(size = 12),     # Y-axis tick labels
    legend.title = element_text(size = 12),     # Legend titles
    legend.text  = element_text(size = 12)      # Legend labels
    )

ggsave("Output/secondary_septa.png", plot = secondary_septa, width = 10, height = 5, dpi = 500)

#ploting the tertiary septa with boxplot and point repartition 
tertiary_septa <- ggplot(sem_clean_data, aes(x = factor(Polyp_number),
                  y = Tertiary_septa,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Tertiary septa width (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 14)+ 
   theme( axis.title.x = element_text(size = 12),     # X-axis title
    axis.title.y = element_text(size = 12),     # Y-axis title
    axis.text.x  = element_text(size = 12),     # X-axis tick labels
    axis.text.y  = element_text(size = 12),     # Y-axis tick labels
    legend.title = element_text(size = 12),     # Legend titles
    legend.text  = element_text(size = 12)      # Legend labels
    )

ggsave("Output/tertiary_septa.png", plot = tertiary_septa, width = 10, height = 5, dpi = 600)

#ploting the columella with boxplot and point repartition 
columella <- ggplot(sem_clean_data, aes(x = factor(Polyp_number),
                  y = Columella,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Columella (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 14)+ 
   theme( axis.title.x = element_text(size = 12),     
    axis.title.y = element_text(size = 12),     
    axis.text.x  = element_text(size = 12),    
    axis.text.y  = element_text(size = 12),     
    legend.title = element_text(size = 12),     
    legend.text  = element_text(size = 12)      
    )

ggsave("Output/columella.png", plot = columella, width = 10, height = 5, dpi = 600)

#merge all the graph in one graph
# Remove legends from all except one (say p1)
p1 <- coralite_diameters + theme(legend.position = "none", 
axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

p2 <- primary_septa + theme(legend.position = "none", axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

p3 <- secondary_septa + theme(legend.position = "none", axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

p4 <- tertiary_septa + theme(legend.position = "none",axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

p5 <- columella + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 

# Combine plots
combined_plot <- (p1 | p2) / (p3 | p4) / (p5)

# Save to file
ggsave("Output/combined_plot.pdf", combined_plot, width = 12, height = 10)


```


```{r}
Coralite_diameters_clean <- ggplot(Corallite_outlier, aes(x = factor(Polyp_number),
                  y = Corallite_Diameter,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Corallite diameter (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 25)+
  theme( axis.title.x = element_text(size = 12),     
    axis.title.y = element_text(size = 12),     
    axis.text.x  = element_text(size = 12),     
    axis.text.y  = element_text(size = 12),     
    legend.title = element_text(size = 12),     
    legend.text  = element_text(size = 12)      
    )

ggsave("Output/Coralite_diameters_clean.png", plot = Coralite_diameters_clean, width = 10, height = 5, dpi = 500)

primary_septa_clean <- ggplot(Psepta_outlier, aes(x = factor(Polyp_number),
                  y = Primary_septa,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Primary septa witdh (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 25)+
  theme( axis.title.x = element_text(size = 12),     
    axis.title.y = element_text(size = 12),     
    axis.text.x  = element_text(size = 12),     
    axis.text.y  = element_text(size = 12),     
    legend.title = element_text(size = 12),     
    legend.text  = element_text(size = 12)      
    )

ggsave("Output/primary_septa_clean.png", plot = primary_septa_clean, width = 10, height = 5, dpi = 500)

secondary_septa_clean <- ggplot(Ssepta_outlier, aes(x = factor(Polyp_number),
                  y = Secondary_septa,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Secondary septa witdh (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 25)+
  theme( axis.title.x = element_text(size = 12),     
    axis.title.y = element_text(size = 12),     
    axis.text.x  = element_text(size = 12),     
    axis.text.y  = element_text(size = 12),     
    legend.title = element_text(size = 12),     
    legend.text  = element_text(size = 12)      
    )

ggsave("Output/secondary_septa_clean.png", plot = secondary_septa_clean, width = 10, height = 5, dpi = 500)

tertiary_septa_clean <- ggplot(Tsepta_outlier, aes(x = factor(Polyp_number),
                  y = Tertiary_septa,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Tertiary septa witdh (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 25)+
  theme( axis.title.x = element_text(size = 12),     
    axis.title.y = element_text(size = 12),     
    axis.text.x  = element_text(size = 12),     
    axis.text.y  = element_text(size = 12),     
    legend.title = element_text(size = 12),     
    legend.text  = element_text(size = 12)      
    )

ggsave("Output/tertiary_septa_clean.png", plot = tertiary_septa_clean, width = 10, height = 5, dpi = 500)

columella_clean <- ggplot(Columella_outlier, aes(x = factor(Polyp_number),
                  y = Columella,
                  fill = factor(Polyp_number),
                  color = factor(Polyp_number))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.8) +
  scale_fill_tableau(palette = "Jewel Bright") +
  scale_color_tableau(palette = "Jewel Bright") +
  labs(x = "Number of polyps per spat",
       y = "Columella (µm)",
       fill = "Polyp Number",
       color = "Polyp Number") +
  theme_minimal(base_size = 25)+
  theme( axis.title.x = element_text(size = 12),     
    axis.title.y = element_text(size = 12),     
    axis.text.x  = element_text(size = 12),     
    axis.text.y  = element_text(size = 12),     
    legend.title = element_text(size = 12),     
    legend.text  = element_text(size = 12)      
    )

ggsave("Output/columella_clean.png", plot = columella_clean, width = 10, height = 5, dpi = 500)

#merge all the graph with no outlier in one graph
# Remove legends from all except one 
P1 <- Coralite_diameters_clean + theme(legend.position = "none", 
axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

P2 <- primary_septa_clean + theme(legend.position = "none", axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

P3 <- secondary_septa_clean + theme(legend.position = "none", axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

P4 <- tertiary_septa_clean + theme(legend.position = "none",axis.title.x = element_blank(),
                 axis.text.x = element_blank(),
                 axis.ticks.x = element_blank())

P5 <- columella_clean + theme(legend.position = "bottom",           
    legend.title.align = 0.5,             
    legend.box = "horizontal") 

# Combine plots
combined_plot_without_outlier <- (P1 | P2) / (P3 | P4) / (P5)

# Save to file
ggsave("Output/combined_plot_without_outlier.pdf", combined_plot_without_outlier, width = 12, height = 10)

```


```{r}
#vizualisation of the data via graph
#CORALLITE
hist(Corallite_outlier$Corallite_Diameter,
     main = "Histogram of Corallite Diameter",
     xlab = "Corallite Diameter",
     breaks = 15)

#PRIMARY SEPTA
hist(Psepta_outlier$Primary_septa,
     main = "Histogram of Primary septa",
     xlab = "Primary septa",
     breaks = 15)

#Secondary SEPTA
hist(Ssepta_outlier$Secondary_septa,
     main = "Histogram of Secondary septa",
     xlab = "Secondary septa",
     breaks = 15)

#tertiary septa
hist(Tsepta_outlier$Tertiary_septa,
     main = "Histogram of Tertiary septa",
     xlab = "Tertiary septa",
     breaks = 15)

#COLUMELLA 
hist(Columella_outlier$Columella,
     main = "Histogram of Columella",
     xlab = "Primary columella",
     breaks = 15)

#Q-Q plot 
#CORALLITE
qqnorm(Corallite_outlier$Corallite_Diameter)
qqline(Corallite_outlier$Corallite_Diameter, col = "red")

#Primary septa
qqnorm(Psepta_outlier$Primary_septa)
qqline(Psepta_outlier$Primary_septa, col = "red")

#secondary septa 
qqnorm(Ssepta_outlier$Secondary_septa)
qqline(Ssepta_outlier$Secondary_septa, col = "red")

#Tertiary septa 
qqnorm(Tsepta_outlier$Tertiary_septa)
qqline(Tsepta_outlier$Tertiary_septa, col = "red")

#Tertiary septa 
qqnorm(Columella_outlier$Columella)
qqline(Columella_outlier$Columella, col = "red")

#statistic part
#normality on coralitte diameter µm 
shapiro.test(residuals(aov(Corallite_Diameter ~ Polyp_number, data = Corallite_outlier)))
#normality validated
#normality on primary septa witdh µm
shapiro.test(residuals(aov(Primary_septa ~ Polyp_number, data = Psepta_outlier)))
#normality validated
#normality on secondary septa witdh µm
shapiro.test(residuals(aov(Secondary_septa ~ Polyp_number, data = Ssepta_outlier)))
#normality validated
#normality on tertiary septa witdh µm
shapiro.test(residuals(aov(Tertiary_septa ~ Polyp_number, data = Tsepta_outlier)))
#do not follow the normality need to used a Kruskal-Wallis test 
#normality on columella witdh µm
shapiro.test(residuals(aov(Columella ~ Polyp_number, data = Columella_outlier)))
#normality validated

#ANOVA test
#CORALLITE
anova_result_coralitte <- aov(Corallite_Diameter ~ factor(Polyp_number), data = Corallite_outlier)
summary(anova_result_coralitte)
#Post-Hoc comparaison 
tukey_result_coralitte <- TukeyHSD(anova_result_coralitte)
tukey_result_coralitte

#creation heat map t vizualize the posthoc test
# Extract Tukey results as a data frame
tukey_df_coralitte <- as.data.frame(tukey_result_coralitte$'factor(Polyp_number)') %>%
  rownames_to_column(var = "comparison") %>%
  select(comparison, `p adj`) %>%
  separate(comparison, into = c("Group1", "Group2"), sep = "-")

# Create a matrix for plotting
heatmap_df_coralitte <- tukey_df_coralitte %>%
  pivot_wider(names_from = Group2, values_from = `p adj`) %>%
  column_to_rownames("Group1")

# Convert to long format for ggplot
heatmap_long_coralitte <- heatmap_df_coralitte %>%
  rownames_to_column("Group1") %>%
  pivot_longer(-Group1, names_to = "Group2", values_to = "p_value")

# Plot
ggplot(heatmap_long_coralitte, aes(x = Group1, y = Group2, fill = p_value)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "red", high = "white", na.value = "grey90",
                      name = "p-value") +
  geom_text(aes(label = round(p_value, 3))) +
  theme_minimal() +
  labs(title = "Tukey HSD Pairwise Comparisons coralitte")

##################

#PRIMARY septa
anova_result_primary <- aov(Primary_septa ~ factor(Polyp_number), data = Psepta_outlier)
summary(anova_result_primary)
#Post-Hoc comparaison 
tukey_result_primary <- TukeyHSD(anova_result_primary)
tukey_result_primary

#creation heat map t vizualize the posthoc test
# Extract Tukey results as a data frame
tukey_df_primary <- as.data.frame(tukey_result_primary$'factor(Polyp_number)') %>%
  rownames_to_column(var = "comparison") %>%
  select(comparison, `p adj`) %>%
  separate(comparison, into = c("Group1", "Group2"), sep = "-")

# Create a matrix for plotting
heatmap_df_primary <- tukey_df_primary %>%
  pivot_wider(names_from = Group2, values_from = `p adj`) %>%
  column_to_rownames("Group1")

# Convert to long format for ggplot
heatmap_long_primary <- heatmap_df_primary %>%
  rownames_to_column("Group1") %>%
  pivot_longer(-Group1, names_to = "Group2", values_to = "p_value")

# Plot
ggplot(heatmap_long_primary, aes(x = Group1, y = Group2, fill = p_value)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "red", high = "white", na.value = "grey90",
                      name = "p-value") +
  geom_text(aes(label = round(p_value, 3))) +
  theme_minimal() +
  labs(title = "Tukey HSD Pairwise Comparisons primary septa")

##################

#Secondary septa
anova_result_secondary <- aov(Secondary_septa ~ factor(Polyp_number), data = Ssepta_outlier)
summary(anova_result_secondary)
#Post-Hoc comparaison 
tukey_result_secondary <- TukeyHSD(anova_result_secondary)
tukey_result_secondary

#creation heat map t vizualize the posthoc test
# Extract Tukey results as a data frame
tukey_df_secondary <- as.data.frame(tukey_result_secondary$'factor(Polyp_number)') %>%
  rownames_to_column(var = "comparison") %>%
  select(comparison, `p adj`) %>%
  separate(comparison, into = c("Group1", "Group2"), sep = "-")

# Create a matrix for plotting
heatmap_df_secondary <- tukey_df_primary %>%
  pivot_wider(names_from = Group2, values_from = `p adj`) %>%
  column_to_rownames("Group1")

# Convert to long format for ggplot
heatmap_long_secondary <- heatmap_df_secondary %>%
  rownames_to_column("Group1") %>%
  pivot_longer(-Group1, names_to = "Group2", values_to = "p_value")

# Plot
ggplot(heatmap_long_secondary, aes(x = Group1, y = Group2, fill = p_value)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "red", high = "white", na.value = "grey90",
                      name = "p-value") +
  geom_text(aes(label = round(p_value, 3))) +
  theme_minimal() +
  labs(title = "Tukey HSD Pairwise Comparisons secondary septa")

##################

#Tertiary septa
anova_result_tertiary <- aov(Tertiary_septa ~ factor(Polyp_number), data = Tsepta_outlier)
summary(anova_result_tertiary)
#Post-Hoc comparaison 
tukey_result_tertiary <- TukeyHSD(anova_result_tertiary)
tukey_result_tertiary

#creation heat map t vizualize the posthoc test
# Extract Tukey results as a data frame
tukey_df_tertiary <- as.data.frame(tukey_result_tertiary$'factor(Polyp_number)') %>%
  rownames_to_column(var = "comparison") %>%
  select(comparison, `p adj`) %>%
  separate(comparison, into = c("Group1", "Group2"), sep = "-")

# Create a matrix for plotting
heatmap_df_tertiary <- tukey_df_tertiary %>%
  pivot_wider(names_from = Group2, values_from = `p adj`) %>%
  column_to_rownames("Group1")

# Convert to long format for ggplot
heatmap_long_tertiary <- heatmap_df_tertiary %>%
  rownames_to_column("Group1") %>%
  pivot_longer(-Group1, names_to = "Group2", values_to = "p_value")

# Plot
ggplot(heatmap_long_tertiary, aes(x = Group1, y = Group2, fill = p_value)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "red", high = "white", na.value = "grey90",
                      name = "p-value") +
  geom_text(aes(label = round(p_value, 3))) +
  theme_minimal() +
  labs(title = "Tukey HSD Pairwise Comparisons tertiary septa")

##################

#Columella 
anova_result_columella <- aov(Columella ~ factor(Polyp_number), data = Columella_outlier)
summary(anova_result_columella)
#Post-Hoc comparaison 
tukey_result_columella <- TukeyHSD(anova_result_columella)
tukey_result_columella

#creation heat map t vizualize the posthoc test
# Extract Tukey results as a data frame
tukey_df_columella <- as.data.frame(tukey_result_columella$'factor(Polyp_number)') %>%
  rownames_to_column(var = "comparison") %>%
  select(comparison, `p adj`) %>%
  separate(comparison, into = c("Group1", "Group2"), sep = "-")

# Create a matrix for plotting
heatmap_df_columella <- tukey_df_columella %>%
  pivot_wider(names_from = Group2, values_from = `p adj`) %>%
  column_to_rownames("Group1")

# Convert to long format for ggplot
heatmap_long_columella <- heatmap_df_columella %>%
  rownames_to_column("Group1") %>%
  pivot_longer(-Group1, names_to = "Group2", values_to = "p_value")

# Plot
ggplot(heatmap_long_columella, aes(x = Group1, y = Group2, fill = p_value)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "red", high = "white", na.value = "grey90",
                      name = "p-value") +
  geom_text(aes(label = round(p_value, 3))) +
  theme_minimal() +
  labs(title = "Tukey HSD Pairwise Comparisons columella")

```


