---
title: "Coral_mineral_analysis"
output: html_document
---
#loading packages
```{r, warning = FALSE}
## load libraries
library(ggplot2)
library(readr)
library(dplyr)
library(tidyverse)
library(gridExtra)
library(ggpubr)
library(lubridate)
library(cowplot)

```
#Import data
```{r, warning = FALSE}
mg_data <- read_csv("Data/Mineral/Magnesium_concentration_coral_mineral.csv")
sr_data <- read.csv("Data/Mineral/Strontium_concentration_coral_mineral.csv")

```

#cleaning dataset 
```{r, warning = FALSE}
# Magnesium data
# Clean column names
colnames(mg_data) <- c("Number.of.polyps", "Concentration", "Error", "X4", "X5", "X6")
mg_data <- mg_data %>% select(Number.of.polyps, Concentration, Error)

# remove the NA from the dataset
mg_data<- na.omit(mg_data)

#Strontium data
# Clean column names
colnames(sr_data) <- c("Number.of.polyps", "Concentration", "Error")
sr_data <- sr_data %>% select(Number.of.polyps, Concentration, Error)

# remove the NA from the dataset
sr_data<- na.omit(sr_data)
```

#plot creation to vizualize the data
```{r, warning = FALSE}
#Magnesium data
# Ensure 'Polyps' is ordered
mg_data$Number.of.polyps <- factor(mg_data$Number.of.polyps, 
                         levels = c("1p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p"))

# Plot Magnesium bar plot with error bars
p_mg <- ggplot(mg_data, aes(x = Number.of.polyps, y = Concentration)) +
  geom_bar(stat = "identity", fill = "red", alpha = 0.6) +  # light red with transparency
  geom_errorbar(aes(ymin = Concentration - Error, ymax = Concentration + Error), width = 0.2) +
  geom_point(size = 2, color = "darkred") +  # data points
  labs(title = "Magnesium concentration", y = "C [at%]", x = "Number of polyps") +
  theme_minimal()


ggsave("Output/Mg_plot.png", plot = p_mg, width = 6, height = 4, dpi = 300)

#Strontium data
# Ensure 'Polyps' is ordered
sr_data$Number.of.polyps <- factor(sr_data$Number.of.polyps, 
                         levels = c("1p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p"))

# Plot Magnesium bar plot with error bars
p_sr <- ggplot(sr_data, aes(x = Number.of.polyps, y = Concentration)) +
  geom_bar(stat = "identity", fill = "blue", alpha = 0.6) +  # light blue with transparency
  geom_errorbar(aes(ymin = Concentration - Error, ymax = Concentration + Error), width = 0.2) +
  geom_point(size = 2, color = "darkblue") +  # data points
  labs(title = "Strontium concentration", y = "C [at%]", x = "Number of polyps") +
  theme_minimal()

ggsave("Output/Sr_plot.png", plot = p_sr, width = 6, height = 4, dpi = 300)


```

#combining magnseium and strontium data on the same graph to vizualize the data we got
```{r, warning = FALSE}
# Add "Element" column to both datasets
mg_data$Element <- "Magnesium"
sr_data$Element <- "Strontium"

# Ensure 'Number.of.polyps' is factor with correct order
ordered_polyps <- c("1p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p")
mg_data$Number.of.polyps <- factor(mg_data$Number.of.polyps, levels = ordered_polyps)
sr_data$Number.of.polyps <- factor(sr_data$Number.of.polyps, levels = ordered_polyps)

# Standardize column names 
mg_data <- mg_data %>% select(Number.of.polyps, Concentration, Error, Element)
sr_data <- sr_data %>% select(Number.of.polyps, Concentration, Error, Element)

#combine data
combined_data <- bind_rows(mg_data, sr_data)

# Plot both elements side by side
p_combined <- ggplot(combined_data, aes(x = Number.of.polyps, y = Concentration, fill = Element)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.6) +
  geom_errorbar(aes(ymin = Concentration - Error, ymax = Concentration + Error), 
                position = position_dodge(width = 0.9), width = 0.2) +
  geom_point(aes(color = Element), position = position_dodge(width = 0.9), size = 2) +
  scale_fill_manual(values = c("Magnesium" = "red", "Strontium" = "blue")) +
  scale_color_manual(values = c("Magnesium" = "darkred", "Strontium" = "darkblue")) +
  labs(title = "Mg and Sr concentration by number of polyps", 
       y = "C [at%]", x = "Number of polyps", fill = "Element", color = "Element") +
  theme_minimal()

ggsave("Output/Sr_Mg_plot.png", plot = p_combined, width = 6, height = 4, dpi = 300)
```

```{r, warning = FALSE}
#creation bar plot with all the data point and the mean bar for both element 
#on Y we will have the number of polyps and on X the C [at%] 

summary_stats <- combined_data %>%
  group_by(Element) %>%
  summarise(
    Mean = mean(Concentration, na.rm = TRUE),
    SE = sd(Concentration, na.rm = TRUE) / sqrt(n())
  )

# Plot
p_scatter_se <- ggplot(combined_data, aes(x = Element, y = Concentration, color = Element)) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 2) +  # All data points
  stat_summary(fun = mean, geom = "point", size = 4) +  # Mean point
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Standard error bars
  scale_color_manual(values = c("Magnesium" = "red", "Strontium" = "blue")) +
  labs(title = "Elemental concentration with mean ± SE",
       x = "Element",
       y = "C [at%]") +
  theme_minimal()


```

# after visiualisation of the graph, some outlier need to be removed. 
```{r, warning = FALSE}
combined_data_clean <- combined_data %>%
  filter(
    Concentration >= quantile(Concentration, 0.25) - 1.5 * IQR(Concentration),
    Concentration <= quantile(Concentration, 0.75) + 1.5 * IQR(Concentration)
  )

boxplot(combined_data$Concentration, main = "Before Removing Outliers")

boxplot(combined_data_clean$Concentration, main = "After Removing Outliers")

```
#new visualisation of the graph without the outlier 
```{r, warning = FALSE}
p_scatter_se_with_no_outlier <- ggplot(combined_data_clean, aes(x = Element, y = Concentration, color = Element)) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 2) +  # All data points
  stat_summary(fun = mean, geom = "point", size = 3) +  # Mean point
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.1) +  # Standard error bars
  scale_color_manual(values = c("Magnesium" = "brown1", "Strontium" = "deepskyblue1")) +
  labs(title = "Elemental concentration with mean ± SE",
       x = NULL,
       y = "C [at%]") + 
  theme_minimal() +
  theme(
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
    axis.text = element_text(size = 10, face = "bold", hjust = 0.5),
    axis.title.y = element_text(size = 10, margin = margin(r = 10), face = "bold", hjust = 0.5),
    panel.grid.major.x = element_blank(),
  )

ggsave("Output/Sr_Mg_plot_SE.png", plot = p_scatter_se_with_no_outlier, width = 6, height = 4, dpi = 300)
```

#ploting for a linear regression and fizualise the comparaison between mg and sr 
```{r, warning = FALSE}
combined_data_lr$Number.of.polyps <- as.numeric(as.character(combined_data_clean$Number.of.polyps))

table(combined_data$Element)
str(combined_data$Element)

# Plot with regression lines
p_lm <- ggplot(combined_data, aes(x = Number.of.polyps, y = Concentration, color = Element, group = Element, fill = Element)) +
  geom_point(alpha = 0.5, size = 2) +
  geom_smooth(method = "lm", se = TRUE, size = 1.2, alpha = 0.2) +
  scale_color_manual(values = c("Magnesium" = "#E74C3C", "Strontium" = "#3498DB")) +
  scale_fill_manual(values = c("Magnesium" = "#E74C3C", "Strontium" = "#3498DB")) +
  labs(
    title = "Linear regression of elemental concentration by number of polyps",
    x = "Number of polyps",
    y = "C [at%]"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 9, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank()
  )

ggsave("Output/Sr_Mg_plot_Lm.png", plot = p_lm, width = 6, height = 4, dpi = 300)
```

```{r, warning = FALSE}


```

```{r, warning = FALSE}


```

```{r, warning = FALSE}


```

```{r, warning = FALSE}


```

```{r, warning = FALSE}


```